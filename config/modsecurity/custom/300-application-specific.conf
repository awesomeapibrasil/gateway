# Application-Specific Rules
# Rules tailored for specific applications and use cases

# API-specific protection
SecRule REQUEST_URI "@beginsWith /api/" "chain,id:300001,msg:'API rate limiting',severity:NOTICE,phase:2"
SecRule REQUEST_HEADERS:X-API-Key "@eq ''" "block"

# GraphQL protection
SecRule REQUEST_URI "@endsWith /graphql" "chain,id:300011,msg:'GraphQL query complexity check',severity:WARNING,phase:2"
SecRule REQUEST_BODY "@rx query.*?\{.*?\{.*?\{.*?\{" "block"

# JWT token validation (basic check)
SecRule REQUEST_HEADERS:Authorization "@rx ^Bearer\s+[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$" "id:300021,msg:'Valid JWT format detected',severity:NOTICE,phase:1,pass"

# Block requests without proper content-type for POST/PUT
SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" "chain,id:300031,msg:'Missing content-type header',severity:WARNING,phase:1"
SecRule REQUEST_HEADERS:Content-Type "@eq ''" "block"

# Protect admin endpoints
SecRule REQUEST_URI "@rx (?i)/admin/" "chain,id:300041,msg:'Admin area access',severity:WARNING,phase:1"
SecRule REQUEST_HEADERS:Authorization "@eq ''" "block"

# Mobile app specific rules
SecRule REQUEST_HEADERS:User-Agent "@rx Mobile|Android|iPhone" "chain,id:300051,msg:'Mobile app request',severity:NOTICE,phase:1"
SecRule REQUEST_HEADERS:X-App-Version "@eq ''" "log"

# Microservice communication validation
SecRule REQUEST_HEADERS:X-Service-Name "@rx ^[a-z0-9\-]+$" "id:300061,msg:'Valid service name',severity:NOTICE,phase:1,pass"

# Database-specific injection patterns
SecRule ARGS "@rx (?i)(mongodb|nosql|cassandra|redis|elastic)" "id:300071,msg:'NoSQL injection attempt',severity:ERROR,phase:2,block"

# Session fixation protection
SecRule REQUEST_HEADERS:Cookie "@rx PHPSESSID|JSESSIONID|ASPSESSIONID" "chain,id:300081,msg:'Session token check',severity:NOTICE,phase:1"
SecRule REQUEST_HEADERS:Cookie "@rx [a-fA-F0-9]{32,}" "pass"

# Business logic protection
SecRule REQUEST_URI "@beginsWith /api/payment" "chain,id:300091,msg:'Payment endpoint protection',severity:CRITICAL,phase:2"
SecRule REQUEST_METHOD "@eq GET" "block"

# Rate limiting for specific endpoints
SecRule REQUEST_URI "@beginsWith /api/auth/login" "id:300101,msg:'Login endpoint accessed',severity:NOTICE,phase:2,log"
SecRule REQUEST_URI "@beginsWith /api/auth/register" "id:300102,msg:'Registration endpoint accessed',severity:NOTICE,phase:2,log"

# File upload restrictions
SecRule REQUEST_URI "@beginsWith /upload" "chain,id:300111,msg:'File upload size check',severity:WARNING,phase:2"
SecRule REQUEST_HEADERS:Content-Length "@gt 52428800" "block"

# Prevent directory listings
SecRule REQUEST_URI "@endsWith /" "chain,id:300121,msg:'Directory listing attempt',severity:WARNING,phase:2"
SecRule REQUEST_HEADERS:Accept "@contains text/html" "log"